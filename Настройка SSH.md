Настройка SSH
=============

Содержание
----------
1. [Краткие сведения](#1.-Краткие-сведения)
2. [2. Настройка сервера](#2.-Настройка-сервера)
3. Установка клиента `ssh` под Windows
4. Генерация ключей на клиенте
5. Передача ключей на сервер
6. Дополнительные изменения в `sshd_config`
   

## 1. Краткие сведения

`ssh` обеспечивает безопасное соединение с сервером, используя шифрованный канал. Протокол обеспечивает неуязвимость к аттакам вида [человек посередине](https://ru.wikipedia.org/wiki/Человек_посередине), и является одним из самых полезных инструментов в арсенале DevOps, который необходимо настроить с самого начала.

Часто используемые команды из семейства `ssh`:

`ssh user@server.addr`

где `user` - логин пользователя _на сервере_ (не на локальной машине, они могут и не совпадать), `server.addr` — адрес сервера, задаётся либо в ip-формате, либо в форме `DNS` (если он настроен). Порт по умолчанию - 22.

>ВНИМАНИЕ!!! Никогда не логиньтесь пользователем `root`. При правильной настройке сервер не должен позволять логининться суперпользователем из удалённой машины.

`ssh -p port user@server.addr`

соединение по порту `port` (если так сконфигурирован `sshd` для большей защищённости)

`ssh user@server.addr /absolute/way/to/script`

позволяет удалённо запустить скрипт или программу, не заходя в терминал (как будто зашёл - выполнил - вышел). Скрипт (и путь к нему) должен быть доступен для `user` и иметь установленный флаг `u+x` (либо тогда запустить его через `/bin/sh /way/to/script`). Эта команда позволит, например, запускать какие-то автоматизированные действия при деплое приложения. Из локальной среды в скрипт можно передавать какие-то данные с помощью `pipe`.

`scp user@server.addr my-local-file user@server.addr:way/from/home/dir`
передача файла с локальной машины на сервер по указанному пути. Обратная передача тоже возможна:

`scp user@server.addr user@server.addr:way/from/home/dir my-local-file`

Таким образом можно скачать себе бекапы (для тех, кто из делает).

## 2. Настройка сервера

### Установка `sshd`
Для работы `ssh` на сервере должен быть запущен демон (процесс, работающий в фоновом режиме). На большинстве серверов он установлен «из коробки». Проверить это можно, введя такие команды:

`ps -aux | grep sshd`

покажет есть ли в системе запущенный процесс.
И слушает ли он 22-й порт (по умолчанию):

`sudo netstat -plant | grep :22`

Обратите внимание, что последняя команда выполняется от суперпользователя. Если ты ешё не в списке разрешённых прользователей `sudo` — самое время это сделать.

В заключении можно попробовать приконнектиться к самому себе:

`telnet localhost 22`

Если же на сервере не установлен `sshd`, то его легко установить с помощью пакетного менеджера:

1. `sudo apt-get update && sudo apt-get upgrade`
2. `sudo apt-get install openssh-server`
3. `sudo systemctl enable ssh --now`

 Последняя команда сразу запустит демон. Если вы хотите запустить его позже (чтобы, например, поменять в конфигурации порт, об этом будет в конце), вводите команду без ключа `--now` а после записи конфига запускайте:

 4. `sudo systemctl start ssh`

### Настройка `firewall`

Тут всё просто. Надо открыть входяшие соединения на порт 22 (или тот, который указан в конфиге) для пакетов TCP. Для `ufw` при использовании стандартного порта команда:

`sudo ufw allow ssh`

при использовании порта, например, 1234:

`sudo ufw allow 1234/tcp`

и далее 

`sudo ufw enable` или `sudo ufw reload`

в зависимости от того, запущен ли был `ufw` ранее.