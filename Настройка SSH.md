Настройка SSH
=============

Содержание
----------
1. [Краткие сведения](#1-Краткие-сведения)
2. [Настройка сервера](#2-Настройка-сервера)
3. [Установка клиента под Windows](#3-установка-клиента-под-windows)
4. [Генерация ключей на клиенте и передача на сервер](#4-генерация-ключей-на-клиенте-и-передача-на-сервер)
5. [Дополнительные изменения в `sshd_config`](#5-дополнительные-изменения-в-sshd_config)
   
---

## 1. Краткие сведения

`ssh` обеспечивает безопасное соединение с сервером, используя шифрованный канал. Протокол обеспечивает неуязвимость к аттакам вида [человек посередине](https://ru.wikipedia.org/wiki/Человек_посередине), и является одним из самых полезных инструментов в арсенале DevOps, который необходимо настроить с самого начала.

Часто используемые команды из семейства `ssh`:

`ssh user@server.addr`

где `user` - логин пользователя _на сервере_ (не на локальной машине, они могут и не совпадать), `server.addr` — адрес сервера, задаётся либо в ip-формате, либо в форме `DNS` (если он настроен). Порт по умолчанию - 22.

>ВНИМАНИЕ!!! Никогда не логиньтесь пользователем `root`. При правильной настройке сервер не должен позволять логининться суперпользователем из удалённой машины.

`ssh -p port user@server.addr`

соединение по порту `port` (если так сконфигурирован `sshd` для большей защищённости)

`ssh user@server.addr /absolute/way/to/script`

позволяет удалённо запустить скрипт или программу, не заходя в терминал (как будто зашёл - выполнил - вышел). Скрипт (и путь к нему) должен быть доступен для `user` и иметь установленный флаг `u+x` (либо тогда запустить его через `/bin/sh /way/to/script`). Эта команда позволит, например, запускать какие-то автоматизированные действия при деплое приложения. Из локальной среды в скрипт можно передавать какие-то данные с помощью `pipe`.

`scp user@server.addr my-local-file user@server.addr:way/from/home/dir`
передача файла с локальной машины на сервер по указанному пути. Обратная передача тоже возможна:

`scp user@server.addr user@server.addr:way/from/home/dir my-local-file`

Таким образом можно скачать себе на локальный компьетер бекапы (для тех, кто из делает).

Вариант команды с указанием нестандартного порта:

`scp -P port user@server.addr my-local-file user@server.addr:way/from/home/dir`

Строчная буква в параметре `-P` — это не ошибка!

## 2. Настройка сервера

### Установка `sshd`
Для работы `ssh` на сервере должен быть запущен демон (процесс, работающий в фоновом режиме). На большинстве серверов он установлен «из коробки». Проверить это можно, введя такие команды:

`ps -aux | grep sshd`

покажет есть ли в системе запущенный процесс.
И слушает ли он 22-й порт (по умолчанию):

`sudo netstat -plant | grep :22`

Обратите внимание, что последняя команда выполняется от суперпользователя. Если ты ешё не в списке разрешённых прользователей `sudo` — самое время это сделать.

В заключении можно попробовать приконнектиться к самому себе:

`telnet localhost 22`

Если же на сервере не установлен `sshd`, то его легко установить с помощью пакетного менеджера:

1. `sudo apt-get update && sudo apt-get upgrade`
2. `sudo apt-get install openssh-server`
3. `sudo systemctl enable ssh --now`

 Последняя команда сразу запустит демон. Если вы хотите запустить его позже (чтобы, например, поменять в конфигурации порт, об этом будет в конце), вводите команду без ключа `--now` а после записи конфига запускайте:

 4. `sudo systemctl start ssh`

### Настройка `firewall`

Тут всё просто. Надо открыть входяшие соединения на порт 22 (или тот, который указан в конфиге) для пакетов TCP. Для `ufw` при использовании стандартного порта команда:

`sudo ufw allow ssh`

при использовании порта, например, 1234:

`sudo ufw allow 1234/tcp`

и далее 

`sudo ufw enable` или `sudo ufw reload`

в зависимости от того, запущен ли был `ufw` ранее.

Вообще, тема настройки и использования `firewall` заслуживает отдельного раздела. Грамотно настроенный, он отсечёт большинство любителей «просто посмотреть» и попутно испортит всё, до чего смогут добраться...

## 3. Установка клиента под Windows

Клиент `ssh` «из коробки» уже предустановлен на большинстве версий `linux` и во всех современных `macOS` (в нём предустановлен и сервер, через ssh пострен удалённый доступ между компьютерами с `macOS`).

Для OS семейства `Windows` разработано множество приложений, совместимых с `OpenSSH`. Некоторые из них требуют небольшой «доработки напильником» для соответствия файла с ключём стандарту. Как правило, это хорошо описано в документации к приложению. Далее рассмотрим установку наиболее популярных программ.

>_Посмотреть, что там у несчастных виндоус-пользователей сейчас в моде. Когда-то был PUTTY..._

## 4. Генерация ключей на клиенте и передача на сервер

В случае использования терминала (что предпочтительно всегда) вы будете иметь полный контроль и понимание происходящих процессов.

Напомним вкраце в чём суть. На клиенте мы генереруем 2 ключа — приватный и публичный. Если не менять настройки (а их нет никакого сиысла менять), они хранятся по адресу `~/.ssh/`. Публичный ключ передаётся на сервер и записывается в файл `~/.ssh/authorized_keys` (в нём может храниться несколько ключей, см. ниже). При выполнении команды `ssh user@server.addr` клиент устанавливает связь с сервером, подписывая сообщение приватным ключом, сервер (расшифровав его с помощью публичного из `~/.ssh/authorized_keys`) понимает, что это доверенный пользователь и даёт доступ без запроса пароля.

Для генерации ключей введите команду:

`ssh-keygen -t rsa`

Последует запросы про имя файла, место хранения. Всё это оставьте по умолчанию (просто жмите enter). Далее утилита попросит придумать и ввести кодовую фразу для шифрования ключа, это совершенно не нужно в нашем случае, и тоже нажмите enter.

По итогу у нас появятся 2 файла:

* `~/.ssh/id_rsa` - приватный ключ
* `~/.ssh/id_rsa.pub` - публичный ключ

Последний нам и нужно передать на сервер. Для этого есть 2 способа. Самый простой — воспользоваться специальной утилитой

`ssh-copy-id user@server.addr`

Последует запрос пароля, ключ перепишется, и теперь можно будет заходить без ввода пароля.

Если `ssh-copy-id` не установлен (будет выведено сообщение `command not found`), тогда эту же процедуру можно сделать вручную, выполнив эти команды:

`ssh user@server.addr "umask 077; test -d .ssh || mkdir .ssh"` - создаём (если таковой нет) директорию `.ssh` с нужным уровнем доступа (чтение-запись-выполнение только для пользователя);

`cat ~/.ssh/id_rsa.pub | ssh user@server.addr "cat >> .ssh/authorized_keys"` - вводим пароль, и ключ добавиться. Обратите внимание на двойные `>>` — мы именно _добавляем_ запись в файл, а не _переписываем_ его _целиков_. В нём могут храниться несколько ключей (например, вы хотите заходить с разных компьютеров, а ещё и с планшета, и т.п.).

## 5. Дополнительные изменения в `sshd_config`
   
Настройки `sshd` храняться в файле `/etc/ssh/sshd_config`, и мы можем изменить некоторые дефолтные свойства. Открыть его для редактирование необходимо под `sudo`.

Итак, ищем параметр `PasswordAuthentication`, раскомментируем и устанавливаем:

`PasswordAuthentication no`

и заодно рядом

`PermitEmptyPasswords no`

тем самым мы запретим кому-нибудь коннектится с помощью пароля. Безусловно, делать это нужно только после правильной настройки доступа без пароля.

Далее, запретим логиниться под `root`ом. Ищем и меняем:

`PermitRootLogin no`

В самом начале можно установить порт для доступа взамен дефолтного **22**:

`Port 12345`

Если вы единственный пользователь сервера, или вас пара-тройка человек, есть смысл вообще ограничить число пользователей, которые могут входить по `ssh`, добавив параметр:

`AllowUsers user1 user2 user3`

логины пользователей разделяются пробелами, а не запятыми.

После всех правок загрузите новую конфигурацию:

`sudo systemctl reload ssh`

